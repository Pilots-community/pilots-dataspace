services:

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: edc
      POSTGRES_PASSWORD: edc
      POSTGRES_DB: provider_controlplane
    ports:
      - "15432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./config/docker/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U edc -d provider_controlplane"]
      interval: 5s
      timeout: 5s
      retries: 10

  vault:
    image: hashicorp/vault:1.15
    container_name: vault
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root-token
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://127.0.0.1:8200"
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 5s
      timeout: 5s
      retries: 10

  did-server:
    image: nginx:alpine
    container_name: did-server
    ports:
      - "9876:9876"
    volumes:
      - ./deployment/assets/issuer/did.json:/usr/share/nginx/html/.well-known/did.json:ro
      - ./deployment/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:9876/.well-known/did.json"]
      interval: 5s
      timeout: 5s
      retries: 10

  provider-identityhub:
    image: identityhub:latest
    container_name: provider-identityhub
    command: >
      sh -c "exec java -Djava.security.egd=file:/dev/urandom
      -Dedc.fs.config=/app/config/identityhub-provider.properties
      -jar identityhub.jar"
    ports:
      - "7090:7090"
      - "7091:7091"
      - "7092:7092"
      - "7093:7093"
      - "7095:7095"
      - "7096:7096"
    volumes:
      - ./config/docker/identityhub-provider.properties:/app/config/identityhub-provider.properties:ro
    depends_on:
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:7090/api/check/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  consumer-identityhub:
    image: identityhub:latest
    container_name: consumer-identityhub
    command: >
      sh -c "exec java -Djava.security.egd=file:/dev/urandom
      -Dedc.fs.config=/app/config/identityhub-consumer.properties
      -jar identityhub.jar"
    ports:
      - "7080:7080"
      - "7081:7081"
      - "7082:7082"
      - "7083:7083"
      - "7085:7085"
      - "7086:7086"
    volumes:
      - ./config/docker/identityhub-consumer.properties:/app/config/identityhub-consumer.properties:ro
    depends_on:
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:7080/api/check/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  provider-controlplane:
    image: controlplane:latest
    container_name: provider-controlplane
    command: >
      sh -c "unset WEB_HTTP_PORT WEB_HTTP_PATH &&
      exec java -Djava.security.egd=file:/dev/urandom
      -Dedc.fs.config=/app/config/controlplane-provider.properties
      -jar edc-controlplane.jar"
    ports:
      - "18181:18181"
      - "19192:19192"
      - "19193:19193"
      - "19194:19194"
    volumes:
      - ./config/docker/controlplane-provider.properties:/app/config/controlplane-provider.properties:ro
    depends_on:
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
      provider-identityhub:
        condition: service_healthy
      did-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:18181/api/check/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  consumer-controlplane:
    image: controlplane:latest
    container_name: consumer-controlplane
    command: >
      sh -c "unset WEB_HTTP_PORT WEB_HTTP_PATH &&
      exec java -Djava.security.egd=file:/dev/urandom
      -Dedc.fs.config=/app/config/controlplane-consumer.properties
      -jar edc-controlplane.jar"
    ports:
      - "28181:28181"
      - "29192:29192"
      - "29193:29193"
      - "29194:29194"
    volumes:
      - ./config/docker/controlplane-consumer.properties:/app/config/controlplane-consumer.properties:ro
    depends_on:
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
      consumer-identityhub:
        condition: service_healthy
      did-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:28181/api/check/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  provider-dataplane:
    image: dataplane:latest
    container_name: provider-dataplane
    command: >
      sh -c "unset WEB_HTTP_PORT WEB_HTTP_PATH &&
      exec java -Djava.security.egd=file:/dev/urandom
      -Dedc.fs.config=/app/config/dataplane.properties
      -jar edc-dataplane.jar"
    ports:
      - "38181:38181"
      - "38182:38182"
      - "38185:38185"
    volumes:
      - ./config/docker/dataplane.properties:/app/config/dataplane.properties:ro
      - ./config/certs:/app/certs:ro
    depends_on:
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
      provider-controlplane:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:38181/api/check/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  consumer-dataplane:
    image: dataplane:latest
    container_name: consumer-dataplane
    command: >
      sh -c "unset WEB_HTTP_PORT WEB_HTTP_PATH &&
      exec java -Djava.security.egd=file:/dev/urandom
      -Dedc.fs.config=/app/config/dataplane-consumer.properties
      -jar edc-dataplane.jar"
    ports:
      - "48181:48181"
      - "48182:48182"
      - "48185:48185"
    volumes:
      - ./config/docker/dataplane-consumer.properties:/app/config/dataplane-consumer.properties:ro
      - ./config/certs:/app/certs:ro
    depends_on:
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
      consumer-controlplane:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:48181/api/check/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  http-receiver:
    image: python:3-alpine
    container_name: http-receiver
    command: python /app/server.py
    ports:
      - "4000:4000"
    volumes:
      - ./deployment/http-receiver/server.py:/app/server.py:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/')"]
      interval: 5s
      timeout: 5s
      retries: 5

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    image: dashboard:latest
    container_name: dashboard
    ports:
      - "3000:80"
    depends_on:
      provider-controlplane:
        condition: service_healthy
      consumer-controlplane:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:80/"]
      interval: 5s
      timeout: 5s
      retries: 10

volumes:
  postgres-data:
